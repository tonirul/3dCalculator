<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D Scientific Calculator</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: var(--bg);
      transition: background 0.4s ease;
    }
    :root {
      --bg-light: #e0e5ec;
      --bg-dark: #1f2225;
      --calc-light: #f0f3f6;
      --calc-dark: #2a2e31;
      --key-bg-light: #e0e5ec;
      --key-bg-dark: #2a2e31;
      --font-light: #333;
      --font-dark: #c0c0c0;
      --key-active-light: #d0d5dc;
      --key-active-dark: #1f2225;
      --special-key-light: #ff7e5f;
      --special-key-dark: #ffc94b;
      --equal-key-light: #76a9f4;
      --equal-key-dark: #4da6ff;
    }
    body.light {
      --bg: var(--bg-light);
      --calc-bg: var(--calc-light);
      --key-bg: var(--key-bg-light);
      --font-color: var(--font-light);
      --box-shadow: 10px 10px 20px #b8c0d1, -10px -10px 20px #ffffff;
      --key-shadow: 6px 6px 12px #b8c0d1, -6px -6px 12px #ffffff;
      --key-inset-shadow: inset 2px 2px 5px #b8c0d1, inset -2px -2px 5px #ffffff;
    }
    body.dark {
      --bg: var(--bg-dark);
      --calc-bg: var(--calc-dark);
      --key-bg: var(--key-bg-dark);
      --font-color: var(--font-dark);
      --box-shadow: 10px 10px 20px #181a1d, -10px -10px 20px #303438;
      --key-shadow: 6px 6px 12px #181a1d, -6px -6px 12px #303438;
      --key-inset-shadow: inset 2px 2px 5px #181a1d, inset -2px -2px 5px #303438;
    }
    .calculator {
      background: var(--calc-bg);
      padding: 25px;
      border-radius: 40px;
      box-shadow: var(--box-shadow);
      width: 350px;
      transition: all 0.4s ease;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 5px;
    }
    .toggle-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      background: var(--key-bg);
      color: var(--font-color);
      box-shadow: var(--key-shadow);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
      font-size: 0.9em;
    }
    .toggle-btn:active {
      box-shadow: var(--key-inset-shadow);
      transform: scale(0.98);
    }
    .display {
      background: var(--calc-bg);
      color: var(--font-color);
      font-size: 1.8em;
      padding: 20px;
      border-radius: 20px;
      margin-bottom: 10px;
      text-align: right;
      min-height: 80px;
      box-shadow: var(--key-inset-shadow);
      overflow-x: auto;
      white-space: nowrap;
    }
    .memory-display {
        background: var(--calc-bg);
        color: var(--font-color);
        font-size: 0.8em;
        padding: 10px 20px;
        border-radius: 20px;
        margin-bottom: 25px;
        text-align: center;
        min-height: 60px;
        box-shadow: var(--key-inset-shadow);
        overflow-y: auto;
        white-space: nowrap;
        opacity: 0.7;
    }
    .pad {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
    }
    .key {
      background: var(--key-bg);
      color: var(--font-color);
      font-size: 1em;
      font-weight: 600;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: var(--key-shadow);
      transition: all 0.2s ease;
    }
    .key.special {
      color: #fff;
      background: linear-gradient(145deg, var(--special-key-light) 0%, var(--special-key-dark) 100%);
    }
    .key.equal {
      background: linear-gradient(145deg, var(--equal-key-light) 0%, var(--equal-key-dark) 100%);
      color: #fff;
      grid-column: span 2;
      border-radius: 24px;
      width: auto;
    }
    .key:active {
      box-shadow: var(--key-inset-shadow);
      transform: scale(0.95);
    }
    .printable-area {
        display: none;
    }
    @media print {
        body > *:not(.printable-area) {
            display: none;
        }
        .printable-area {
            display: block;
            margin: 0;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #000;
        }
    }
  </style>
</head>
<body class="dark">
  <div class="calculator" id="calculator">
    <div class="top-bar">
      <button class="toggle-btn" id="theme-toggle">üåô/üåû</button>
      <button class="toggle-btn" id="sci-toggle">Sci</button>
      <button class="toggle-btn" id="angle-toggle">DEG</button>
      <button class="toggle-btn" id="print-btn">üñ®Ô∏è</button>
      <button class="toggle-btn" id="fullscreen-btn">‚õ∂</button>
    </div>
    <div class="display" id="display">0</div>
    <div class="memory-display" id="memory-display"></div>
    <div class="pad" id="pad"></div>
  </div>

  <div class="printable-area" id="printable-history"></div>

  <script>
    const pad = document.getElementById("pad");
    const display = document.getElementById("display");
    const memoryDisplay = document.getElementById("memory-display");
    const themeToggle = document.getElementById("theme-toggle");
    const sciToggle = document.getElementById("sci-toggle");
    const angleToggle = document.getElementById("angle-toggle");
    const printBtn = document.getElementById("print-btn");
    const fullscreenBtn = document.getElementById("fullscreen-btn");
    const printableHistory = document.getElementById("printable-history");
    const calculator = document.getElementById("calculator");

    // fullscreen toggle
    fullscreenBtn.onclick = () => {
      if (!document.fullscreenElement) {
        calculator.requestFullscreen().catch(err => {
          alert(`Error enabling fullscreen: ${err.message}`);
        });
      } else {
        document.exitFullscreen();
      }
    };

    let expr = "", memory = 0, lastAns = 0, isSci = true, isDeg = true;
    let history = [];
    const maxHistory = 10;
    let currentPageIndex = -1;

    const basicKeys = ["C","DEL","%","/","*","7","8","9","+","-","4","5","6","(",")","1","2","3","ANS","œÄ","0",".","="];
    const sciKeys = ["x¬≤","‚àö","sin","cos","tan","x ∏","log","ln","e","!","MC","MR","M+","M-","DEG"];

    function renderKeys(){
      pad.innerHTML = "";
      let keys = [...basicKeys];
      if(isSci) keys = [...sciKeys, ...basicKeys];
      keys.forEach(k=>{
        const btn = document.createElement("button");
        btn.className = "key";
        if(["C","DEL","+","-","*","/","%","=","x¬≤","‚àö","x ∏","log","ln","sin","cos","tan","e","!","ANS","œÄ"].includes(k)) btn.classList.add("special");
        if(k === "=") btn.classList.add("equal");
        btn.textContent = k;
        btn.onclick = ()=> handleKey(k);
        pad.appendChild(btn);
      });
    }

    function updateMemoryDisplay() {
      memoryDisplay.innerHTML = "";
      if (history.length > 0 && currentPageIndex !== -1) {
        const currentItem = history[currentPageIndex];
        const p = document.createElement("p");
        p.textContent = currentItem;
        memoryDisplay.appendChild(p);
      } else {
        memoryDisplay.textContent = "No history";
      }
      memoryDisplay.innerHTML += `
        <div style="display:flex; justify-content: space-between; margin-top: 10px;">
          <button class="toggle-btn" onclick="prevPage()" ${currentPageIndex <= 0 ? 'disabled' : ''}>&lt; Prev</button>
          <button class="toggle-btn" onclick="nextPage()" ${currentPageIndex >= history.length - 1 ? 'disabled' : ''}>Next &gt;</button>
        </div>
      `;
    }

    function nextPage() {
      if (currentPageIndex < history.length - 1) {
        currentPageIndex++;
        updateMemoryDisplay();
      }
    }
    function prevPage() {
      if (currentPageIndex > 0) {
        currentPageIndex--;
        updateMemoryDisplay();
      }
    }

    function addCalculationToHistory(expression, result) {
      history.push(`${expression} = ${result}`);
      if (history.length > maxHistory) history.shift();
      currentPageIndex = history.length - 1;
      updateMemoryDisplay();
      updatePrintableArea();
    }
    function updatePrintableArea() {
      printableHistory.innerHTML = "";
      history.forEach((item, index) => {
        const p = document.createElement("p");
        p.textContent = `${index + 1}. ${item}`;
        printableHistory.appendChild(p);
      });
    }

    function isLastCharOperator(expression) {
      const operators = ['+','-','*','/','%','**','(',')'];
      return operators.some(op => expression.endsWith(op));
    }

    function handleKey(k){
      if(k === "C") expr = "";
      else if(k === "DEL") expr = expr.slice(0,-1);
      else if(k === "=") evaluate();
      else if(k === "ANS") expr += lastAns;
      else if(k === "œÄ") expr += Math.PI;
      else if(k === "e") expr += Math.E;
      else if(k === "‚àö") {
        if (!isLastCharOperator(expr) && expr !== "") return;
        expr += "Math.sqrt(";
      } else if(k === "x¬≤") expr += "**2";
      else if(k === "x ∏") {
        if (isLastCharOperator(expr) || expr === "") return;
        expr += "**";
      }
      else if(k === "%") {
        if (isLastCharOperator(expr) || expr === "") return;
        expr += "/100";
      }
      else if(["sin","cos","tan"].includes(k)) {
        if (!isLastCharOperator(expr) && expr !== "") return;
        expr += `Math.${k}(`;
      }
      else if(k === "log") {
        if (!isLastCharOperator(expr) && expr !== "") return;
        expr += "Math.log10(";
      }
      else if(k === "ln") {
        if (!isLastCharOperator(expr) && expr !== "") return;
        expr += "Math.log(";
      }
      else if(k === "!") {
        if (isLastCharOperator(expr) || expr === "") return;
        expr += "factorial(";
      }
      else if(["MC","MR","M+","M-"].includes(k)) memoryOps(k);
      else {
        if (k === '.') {
          const lastNumber = expr.split(/[\+\-\*\/\%]/).pop();
          if (lastNumber && lastNumber.includes('.')) return;
        }
        const operators = ['+','-','*','/','%'];
        const lastChar = expr.slice(-1);
        if (operators.includes(k) && operators.includes(lastChar)) return;
        expr += k;
      }

      if (k === '=') {
        display.textContent = lastAns || "0";
      } else {
        display.textContent = expr || "0";
      }
    }

    function evaluate(){
      const originalExpr = expr;
      try{
        let toEval = expr.replace(/(\d+)!/g, (_, num) => `factorial(${num})`);
        toEval = toEval.replace(/\+\-/g, '-');
        if(isDeg){
          toEval = toEval.replace(/Math.(sin|cos|tan)\(([^)]+)\)/g,(m,fn,arg)=>`Math.${fn}((${arg})*Math.PI/180)`);
        }
        let result = Function("factorial = (n) => { if (n < 0) return NaN; if (n === 0) return 1; let res = 1; for(let i=1; i<=n; i++) res *= i; return res; }; return "+toEval)();
        if(typeof result === "number" && !isNaN(result)){
          lastAns = result;
          display.innerHTML = `<strong>${result}</strong>`;
          addCalculationToHistory(originalExpr, result);
          expr = "";
        } else {
          display.textContent = "Error";
          expr = "";
        }
      }catch{
        display.textContent = "Error";
        expr = "";
      }
    }

    function memoryOps(k){
      if(k==="MC") memory = 0;
      else if(k==="MR") expr += memory;
      else if(k==="M+") memory += Number(eval(expr) || 0);
      else if(k==="M-") memory -= Number(eval(expr) || 0);
    }

    themeToggle.onclick = ()=>{
      document.body.classList.toggle("dark");
      document.body.classList.toggle("light");
    };
    sciToggle.onclick = ()=>{
      isSci = !isSci;
      sciToggle.textContent = isSci ? "Sci" : "Basic";
      renderKeys();
    };
    angleToggle.onclick = ()=>{
      isDeg = !isDeg;
      angleToggle.textContent = isDeg?"DEG":"RAD";
    };
    printBtn.onclick = () => { window.print(); };

    renderKeys();
    updatePrintableArea();
    updateMemoryDisplay();

    // Keyboard support
    document.addEventListener("keydown", (event) => {
      const key = event.key;
      if (key >= '0' && key <= '9') handleKey(key);
      else if (key === '.') handleKey('.');
      else if (key === '+') handleKey('+');
      else if (key === '-') handleKey('-');
      else if (key === '*' || key === 'x') handleKey('*');
      else if (key === '/') handleKey('/');
      else if (key === '(') handleKey('(');
      else if (key === ')') handleKey(')');
      else if (key === 'Enter' || key === '=') { event.preventDefault(); handleKey('='); }
      else if (key === 'Backspace') handleKey('DEL');
      else if (key.toLowerCase() === 'c') handleKey('C');
      else if (key === '%') handleKey('%');
    });
  </script>
</body>
</html>
